{"title":"使用Angular Universal做ssr渲染","date":"2021-12-12T18:34:32.000Z","date_formatted":{"ll":"Dec 12, 2021","L":"12/12/2021","MM-DD":"12-12"},"link":"2021/12/12/使用angular-universal做ssr渲染","tags":["angular","ssr"],"updated":"2023-10-11T09:13:53.926Z","content":"<p>最近在公司的项目中用到了react做ssr渲染，于是想在angular中也试试，angular在很久之前就出了做ssr渲染的库，名字是<code>@nguniversal/express-engine</code>,使用<code>ng add</code>可以稳定的将自己的项目转化为<code>ssr</code>渲染模式</p>\n<h3 id=\"如何构建服务端渲染项目\">如何构建服务端渲染项目<a href=\"#如何构建服务端渲染项目\" title=\"如何构建服务端渲染项目\"></a></h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ng add @nguniversal/express-engine</span><br></pre></td></tr></table></figure><p>这样我们的项目中会多出几个文件，分别是</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">src/</span><br><span class=\"line\">  main.server.ts             * bootstrapper <span class=\"keyword\">for</span> server app</span><br><span class=\"line\">  app/ ...                   application code</span><br><span class=\"line\">    app.server.module.ts     * server-side application module</span><br><span class=\"line\">server.ts                    * express web server</span><br><span class=\"line\">tsconfig.server.json         TypeScript server application configuration</span><br></pre></td></tr></table></figure><p>首先是<code>main.server.ts</code>文件如下：这个文件主要是服务端渲染的初始化文件，包括设置环境<code>enableProdMode</code>以及<code>export AppServerModule</code>模块在<code>server</code>中<code>bootstrap</code></p>\n<ul><li><code>main.server.ts</code></li>\n</ul><figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/***************************************************************************************************</span></span><br><span class=\"line\"><span class=\"comment\"> * Initialize the server environment - for example, adding DOM built-in types to the global scope.</span></span><br><span class=\"line\"><span class=\"comment\"> *</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">NOTE:</span></span></span><br><span class=\"line\"><span class=\"comment\"> * This import must come before any imports (direct or transitive) that rely on DOM built-ins being</span></span><br><span class=\"line\"><span class=\"comment\"> * available, such as `<span class=\"doctag\">@angular</span>/elements`.</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"keyword\">import</span> <span class=\"string\">'@angular/platform-server/init'</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> &#123; enableProdMode &#125; <span class=\"keyword\">from</span> <span class=\"string\">'@angular/core'</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> &#123; environment &#125; <span class=\"keyword\">from</span> <span class=\"string\">'./environments/environment'</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span> (environment.production) &#123;</span><br><span class=\"line\">  enableProdMode()</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">export</span> &#123; AppServerModule &#125; <span class=\"keyword\">from</span> <span class=\"string\">'./app/app.server.module'</span></span><br><span class=\"line\"><span class=\"keyword\">export</span> &#123; renderModule, renderModuleFactory &#125; <span class=\"keyword\">from</span> <span class=\"string\">'@angular/platform-server'</span></span><br></pre></td></tr></table></figure><p>其次一个比较重要的文件是<code>server.ts</code>文件：这里是<code>express</code>启动的地方，以及各种服务端的中间处理逻辑都写在这里。</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> <span class=\"string\">'zone.js/dist/zone-node'</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> &#123; ngExpressEngine &#125; <span class=\"keyword\">from</span> <span class=\"string\">'@nguniversal/express-engine'</span></span><br><span class=\"line\"><span class=\"keyword\">import</span> * <span class=\"keyword\">as</span> express <span class=\"keyword\">from</span> <span class=\"string\">'express'</span></span><br><span class=\"line\"><span class=\"keyword\">import</span> &#123; join &#125; <span class=\"keyword\">from</span> <span class=\"string\">'path'</span></span><br><span class=\"line\"><span class=\"keyword\">import</span> &#123; createProxyMiddleware &#125; <span class=\"keyword\">from</span> <span class=\"string\">'http-proxy-middleware'</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> &#123; AppServerModule &#125; <span class=\"keyword\">from</span> <span class=\"string\">'./src/main.server'</span></span><br><span class=\"line\"><span class=\"keyword\">import</span> &#123; APP_BASE_HREF &#125; <span class=\"keyword\">from</span> <span class=\"string\">'@angular/common'</span></span><br><span class=\"line\"><span class=\"keyword\">import</span> &#123; existsSync &#125; <span class=\"keyword\">from</span> <span class=\"string\">'fs'</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// The Express app is exported so that it can be used by serverless Functions.</span></span><br><span class=\"line\"><span class=\"keyword\">export</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">app</span>(<span class=\"params\"></span>): <span class=\"title\">express</span>.<span class=\"title\">Express</span> </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">const</span> server = express()</span><br><span class=\"line\">  <span class=\"keyword\">const</span> distFolder = join(process.cwd(), <span class=\"string\">'dist/mean-app/browser'</span>)</span><br><span class=\"line\">  <span class=\"keyword\">const</span> indexHtml = existsSync(join(distFolder, <span class=\"string\">'index.original.html'</span>))</span><br><span class=\"line\">    ? <span class=\"string\">'index.original.html'</span></span><br><span class=\"line\">    : <span class=\"string\">'index'</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">// Our Universal express-engine (found @ https://github.com/angular/universal/tree/master/modules/express-engine)</span></span><br><span class=\"line\">  server.engine(</span><br><span class=\"line\">    <span class=\"string\">'html'</span>,</span><br><span class=\"line\">    ngExpressEngine(&#123;</span><br><span class=\"line\">      bootstrap: AppServerModule,</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">  )</span><br><span class=\"line\"></span><br><span class=\"line\">  server.set(<span class=\"string\">'view engine'</span>, <span class=\"string\">'html'</span>)</span><br><span class=\"line\">  server.set(<span class=\"string\">'views'</span>, distFolder)</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">// Example Express Rest API endpoints</span></span><br><span class=\"line\">  <span class=\"comment\">// server.get('/api/**', (req, res) =&gt; &#123; &#125;);</span></span><br><span class=\"line\">  <span class=\"comment\">// Serve static files from /browser</span></span><br><span class=\"line\">  server.get(</span><br><span class=\"line\">    <span class=\"string\">'*.*'</span>,</span><br><span class=\"line\">    express.static(distFolder, &#123;</span><br><span class=\"line\">      maxAge: <span class=\"string\">'1y'</span>,</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">  )</span><br><span class=\"line\">  server.use(</span><br><span class=\"line\">    <span class=\"string\">'/api'</span>,</span><br><span class=\"line\">    createProxyMiddleware(&#123;</span><br><span class=\"line\">      target: <span class=\"string\">'https://data.mongodb-api.com/...'</span>,</span><br><span class=\"line\">      changeOrigin: <span class=\"literal\">true</span>,</span><br><span class=\"line\">      pathRewrite: &#123;</span><br><span class=\"line\">        <span class=\"string\">'^/api'</span>: <span class=\"string\">'/'</span>, <span class=\"comment\">// rewrite path</span></span><br><span class=\"line\">      &#125;,</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">  )</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">// All regular routes use the Universal engine</span></span><br><span class=\"line\">  server.get(<span class=\"string\">'*'</span>, (req, res) =&gt; &#123;</span><br><span class=\"line\">    res.render(indexHtml, &#123;</span><br><span class=\"line\">      req,</span><br><span class=\"line\">      providers: [&#123; <span class=\"attr\">provide</span>: APP_BASE_HREF, <span class=\"attr\">useValue</span>: req.baseUrl &#125;],</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">  &#125;)</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">return</span> server</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">run</span>(<span class=\"params\"></span>): <span class=\"title\">void</span> </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">const</span> port = process.env.PORT || <span class=\"number\">4000</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">// Start up the Node server</span></span><br><span class=\"line\">  <span class=\"keyword\">const</span> server = app()</span><br><span class=\"line\">  server.listen(port, () =&gt; &#123;</span><br><span class=\"line\">    <span class=\"built_in\">console</span>.log(<span class=\"string\">`Node Express server listening on http://localhost:<span class=\"subst\">$&#123;port&#125;</span>`</span>)</span><br><span class=\"line\">  &#125;)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// Webpack will replace 'require' with '__webpack_require__'</span></span><br><span class=\"line\"><span class=\"comment\">// '__non_webpack_require__' is a proxy to Node 'require'</span></span><br><span class=\"line\"><span class=\"comment\">// The below code is to ensure that the server is run only when not requiring the bundle.</span></span><br><span class=\"line\">declare <span class=\"keyword\">const</span> __non_webpack_require__: NodeRequire</span><br><span class=\"line\"><span class=\"keyword\">const</span> mainModule = __non_webpack_require__.main</span><br><span class=\"line\"><span class=\"keyword\">const</span> moduleFilename = (mainModule &amp;&amp; mainModule.filename) || <span class=\"string\">''</span></span><br><span class=\"line\"><span class=\"keyword\">if</span> (moduleFilename === __filename || moduleFilename.includes(<span class=\"string\">'iisnode'</span>)) &#123;</span><br><span class=\"line\">  run()</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">export</span> * <span class=\"keyword\">from</span> <span class=\"string\">'./src/main.server'</span></span><br></pre></td></tr></table></figure><p>这里主要的逻辑有</p>\n<ul><li>1.服务端<code>express</code>引擎处理html</li>\n<li>2.设置静态文件的加载</li>\n<li>3.设置路由</li>\n<li>4.对<code>response</code>和<code>request</code>做处理(middleware)</li>\n</ul><p>最后是<code>app.server.module.ts</code>是整个angular应用的顶层模块注入管理，在<code>@NgModule</code>中引入了两个新的模块处理服务端渲染的状态管理和模块注入。</p>\n<h4 id=\"坑点1\">坑点1<a href=\"#坑点1\" title=\"坑点1\"></a></h4><p>正常来说，通过Angular的<code>ng add @nguniversal/express-engine</code>这行命令就可以自动帮助我们构建服务端渲染程序。但是我遇到一个问题是之前<code>CSR</code>渲染时<code>router</code>定义的方法是通过<code>routerModule</code>定义注入进<code>AppModule</code>的方式：</p>\n<figure class=\"highlight ts\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> &#123; NgModule &#125; <span class=\"keyword\">from</span> <span class=\"string\">'@angular/core'</span>;</span><br><span class=\"line\"><span class=\"keyword\">import</span> &#123; Routes, RouterModule &#125; <span class=\"keyword\">from</span> <span class=\"string\">'@angular/router'</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">const</span> routes: Routes = [...];</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">@NgModule</span>(&#123;</span><br><span class=\"line\">  imports: [RouterModule.forRoot(routes, &#123; relativeLinkResolution: <span class=\"string\">'legacy'</span> &#125;)],</span><br><span class=\"line\">  exports: [RouterModule],</span><br><span class=\"line\">&#125;)</span><br><span class=\"line\"><span class=\"keyword\">export</span> <span class=\"keyword\">class</span> AppRoutingModule &#123;&#125;</span><br></pre></td></tr></table></figure><p>这样的方式在服务端渲染时并未生效，于是查看了一下文档发现最新文档已经不用这样写了，直接定义<code>routes</code>，然后在<code>AppModule</code>中<code>RouterModule.forRoot(routes,...）</code>注入就可以了！</p>\n<h4 id=\"坑点2\">坑点2<a href=\"#坑点2\" title=\"坑点2\"></a></h4><p>由于我的个人项目是使用<code>tailwindcss</code>管理样式，这样在服务端渲染时，加载的时间会特别长，看了一下<code>tailwindcss</code>在本地开发是全量打包进<code>style</code>里的，于是每次加载的时候都会加载这个包，这个包体积很大，tailwind官方有<code>shaking</code>的配置，但建议是在生产环境下再进行<code>shaking</code>，原理也就是通过正则对<code>html</code>分析然后剔除不用的类。于是乎被迫在本地开发的情况开启了：</p>\n<figure class=\"highlight ts\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">module</span>.exports = &#123;</span><br><span class=\"line\">    prefix: <span class=\"string\">''</span>,</span><br><span class=\"line\">    purge: &#123;</span><br><span class=\"line\">      enabled:  <span class=\"literal\">true</span>,</span><br><span class=\"line\">      content: [</span><br><span class=\"line\">        <span class=\"string\">'./src/**/*.&#123;html,ts&#125;'</span>,</span><br><span class=\"line\">      ]</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    ...</span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure><h4 id=\"坑点3：重复渲染请求\">坑点3：重复渲染/请求<a href=\"#坑点3：重复渲染请求\" title=\"坑点3：重复渲染/请求\"></a></h4><p>基于Angular universal的处理会在服务端渲染以及<code>hydrate</code>后在浏览器再执行一遍<code>render</code>，这个目前看起来不是很理解，官方目前也知道这个问题，于是有处理方案：</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> &#123;TransferHttpCacheModule&#125; <span class=\"keyword\">from</span> <span class=\"string\">'@nguniversal/common'</span>;</span><br></pre></td></tr></table></figure><p><a href=\"https://github.com/angular/universal/blob/master/docs/transfer-http.md\" target=\"_blank\">TransferHttpCacheModule</a></p>\n<h5 id=\"一个issue\">一个issue<a href=\"#一个issue\" title=\"一个issue\"></a></h5><p><a href=\"https://github.com/angular/angular/issues/23427\" target=\"_blank\">Angular - TransferState - page is loading twice (flickering) issue</a></p>\n<p>主要是<code>import</code>进<code>TransferHttpCacheModule</code>注入至全局Module，这样可以缓存内部<code>httpClientModule</code>发起的<code>http</code>请求，防止重复请求闪屏的出现。</p>\n<p>暂时就这些问题，先记录一下。</p>\n","next":{"title":"有关Angular新一代编译引擎Ivy的介绍","link":"2021/07/22/有关Angular新一代编译引擎Ivy的介绍"},"plink":"https://edsion11.github.io/2021/12/12/使用angular-universal做ssr渲染/","toc":[{"id":"如何构建服务端渲染项目","title":"如何构建服务端渲染项目","index":"1","children":[{"id":"坑点1","title":"坑点1","index":"1.1"},{"id":"坑点2","title":"坑点2","index":"1.2"},{"id":"坑点3：重复渲染请求","title":"坑点3：重复渲染&#x2F;请求","index":"1.3"}]}],"copyright":{"author":"Edsion Gu","link":"<a href=\"https://edsion11.github.io/2021/12/12/使用angular-universal做ssr渲染/\" title=\"使用Angular Universal做ssr渲染\">https://edsion11.github.io/2021/12/12/使用angular-universal做ssr渲染/</a>","license":"Attribution-NonCommercial-NoDerivatives 4.0 International (<a href=\"https://creativecommons.org/licenses/by-nc-sa/4.0/\" rel=\"external nofollow noopener\" target=\"_blank\">CC BY-NC-ND 4.0</a>)"}}