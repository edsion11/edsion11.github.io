{"title":"手动实现的call,apply,bind,new","date":"2020-06-27T19:52:13.000Z","date_formatted":{"ll":"Jun 27, 2020","L":"06/27/2020","MM-DD":"06-27"},"link":"2020/06/27/手动实现的call-apply-bind-new","tags":["apply","bind","call","new"],"updated":"2022-01-22T09:45:40.643Z","content":"<h4 id=\"call\">call<a href=\"#call\" title=\"call\"></a></h4><p><code>call()</code> 方法使用一个指定的 <code>this</code> 值和单独给出的一个或多个参数来调用一个函数<br>语法：<code>function.call(thisArg, arg1, arg2, ...)</code></p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">Function</span>.prototype.mycall = <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">thisArg, ...args</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"comment\">//console.log(this)</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (<span class=\"keyword\">typeof</span> <span class=\"keyword\">this</span> !== <span class=\"string\">'function'</span>) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> <span class=\"built_in\">TypeError</span>(<span class=\"string\">'error'</span>)</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">const</span> fn = <span class=\"built_in\">Symbol</span>(<span class=\"string\">'fn'</span>) <span class=\"comment\">// 声明一个独有的Symbol属性, 防止fn覆盖已有属性</span></span><br><span class=\"line\">  thisArg = thisArg || global || <span class=\"built_in\">window</span> <span class=\"comment\">// 若没有传入this, 默认绑定window对象</span></span><br><span class=\"line\">  thisArg[fn] = <span class=\"keyword\">this</span> <span class=\"comment\">// this指向调用call的对象,即我们要改变this指向的函数</span></span><br><span class=\"line\">  <span class=\"keyword\">const</span> result = thisArg[fn](...args) <span class=\"comment\">// 执行当前函数</span></span><br><span class=\"line\">  <span class=\"keyword\">delete</span> thisArg[fn] <span class=\"comment\">// 删除我们声明的fn属性</span></span><br><span class=\"line\">  <span class=\"keyword\">return</span> result</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">greet</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">var</span> reply = [<span class=\"keyword\">this</span>.animal, <span class=\"string\">'typically sleep between'</span>, <span class=\"keyword\">this</span>.sleepDuration].join(</span><br><span class=\"line\">    <span class=\"string\">' '</span></span><br><span class=\"line\">  )</span><br><span class=\"line\">  <span class=\"built_in\">console</span>.log(reply)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">global.obj = &#123;</span><br><span class=\"line\">  animal: <span class=\"string\">'cats'</span>,</span><br><span class=\"line\">  sleepDuration: <span class=\"string\">'12 and 16 hours'</span>,</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">greet()<span class=\"comment\">// typically sleep between</span></span><br><span class=\"line\">greet.mycall(obj)<span class=\"comment\">//cats typically sleep between 12 and 16 hours</span></span><br></pre></td></tr></table></figure><h4 id=\"apply\">apply<a href=\"#apply\" title=\"apply\"></a></h4><p><code>apply()</code> 方法调用一个具有给定this值的函数，以及作为一个数组（或类似数组对象）提供的参数。<br>语法：<code>func.apply(thisArg, [argsArray])</code></p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">Function</span>.prototype.myApply = <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">thisArg, args</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (<span class=\"keyword\">typeof</span> <span class=\"keyword\">this</span> !== <span class=\"string\">'function'</span>) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> <span class=\"built_in\">TypeError</span>(<span class=\"string\">'error'</span>)</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">const</span> fn = <span class=\"built_in\">Symbol</span>(<span class=\"string\">'fn'</span>) <span class=\"comment\">// 声明一个独有的Symbol属性, 防止fn覆盖已有属性</span></span><br><span class=\"line\">  thisArg = thisArg || <span class=\"built_in\">window</span> <span class=\"comment\">// 若没有传入this, 默认绑定window对象</span></span><br><span class=\"line\">  thisArg[fn] = <span class=\"keyword\">this</span> <span class=\"comment\">// this指向调用call的对象,即我们要改变this指向的函数</span></span><br><span class=\"line\">  <span class=\"keyword\">const</span> result = thisArg[fn](...args) <span class=\"comment\">// 执行当前函数</span></span><br><span class=\"line\">  <span class=\"keyword\">delete</span> thisArg[fn] <span class=\"comment\">// 删除我们声明的fn属性</span></span><br><span class=\"line\">  <span class=\"keyword\">return</span> result <span class=\"comment\">// 返回函数执行结果</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\">greet.myApply(obj, [])<span class=\"comment\">//cats typically sleep between 12 and 16 hours</span></span><br></pre></td></tr></table></figure><h4 id=\"bind\">Bind<a href=\"#bind\" title=\"Bind\"></a></h4><p><code>bind()</code> 方法创建一个新的函数，在 bind() 被调用时，这个新函数的 this 被指定为 bind() 的第一个参数，而其余参数将作为新函数的参数，供调用时使用。<br>语法: <code>function.bind(thisArg, arg1, arg2, ...)</code><br>注意三点:</p>\n<ul><li>bind()除了this还接收其他参数，bind()返回的函数也接收参数，这两部分的参数都要传给返回的函数</li>\n<li>new会改变this指向：如果bind绑定后的函数被new了，那么this指向会发生改变，指向当前函数的实例</li>\n<li>没有保留原函数在原型链上的属性和方法<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">Function</span>.prototype.myBind = <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">thisArg, ...args</span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (<span class=\"keyword\">typeof</span> <span class=\"keyword\">this</span> !== <span class=\"string\">'function'</span>) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">throw</span> <span class=\"built_in\">TypeError</span>(<span class=\"string\">'Bind must be called on a function'</span>)</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">var</span> self = <span class=\"keyword\">this</span></span><br><span class=\"line\">  <span class=\"comment\">// new优先级</span></span><br><span class=\"line\">  <span class=\"keyword\">var</span> fbound = <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">    self.apply(</span><br><span class=\"line\">      <span class=\"keyword\">this</span> <span class=\"keyword\">instanceof</span> self ? <span class=\"keyword\">this</span> : thisArg,</span><br><span class=\"line\">      args.concat(<span class=\"built_in\">Array</span>.prototype.slice.call(<span class=\"built_in\">arguments</span>))</span><br><span class=\"line\">    )</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"comment\">// 继承原型上的属性和方法</span></span><br><span class=\"line\">  fbound.prototype = <span class=\"built_in\">Object</span>.create(self.prototype)</span><br><span class=\"line\">  <span class=\"keyword\">return</span> fbound</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"keyword\">let</span> result = greet.bind(obj)</span><br><span class=\"line\">result()<span class=\"comment\">//cats typically sleep between 12 and 16 hours</span></span><br></pre></td></tr></table></figure><h4 id=\"new\">new<a href=\"#new\" title=\"new\"></a></h4></li>\n</ul><p>首先我们要知道new做了什么</p>\n<ul><li>创建一个新对象，并继承其构造函数的prototype，这一步是为了继承构造函数原型上的属性和方法</li>\n<li>执行构造函数，方法内的this被指定为该新实例，这一步是为了执行构造函数内的赋值操作</li>\n<li>返回新实例（规范规定，如果构造方法返回了一个对象，那么返回该对象，否则返回第一步创建的新对象）<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">myNew</span>(<span class=\"params\">item,...args</span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">let</span> obj = <span class=\"built_in\">Object</span>.create(item.prototype)</span><br><span class=\"line\">    <span class=\"comment\">//这里要注意是否对象会有返回值</span></span><br><span class=\"line\">    <span class=\"keyword\">let</span> result = item.apply(obj,args)</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"keyword\">typeof</span> item()===<span class=\"literal\">undefined</span>?obj:result</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">Book</span>(<span class=\"params\">name</span>)</span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">this</span>.name = name</span><br><span class=\"line\">    <span class=\"keyword\">return</span> &#123;</span><br><span class=\"line\">        name:name</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"keyword\">let</span> b1 = myNew(Book,<span class=\"string\">\"javaScript\"</span>)</span><br><span class=\"line\"><span class=\"keyword\">let</span> b2 = <span class=\"keyword\">new</span> Book(<span class=\"string\">\"javaScript\"</span>)</span><br><span class=\"line\"><span class=\"keyword\">let</span> obj1 = <span class=\"keyword\">new</span> <span class=\"built_in\">Object</span>()</span><br><span class=\"line\">Book.apply(obj1,[<span class=\"string\">\"123\"</span>])</span><br><span class=\"line\"><span class=\"built_in\">console</span>.log(obj1)<span class=\"comment\">//&#123; name: '123' &#125;</span></span><br><span class=\"line\"><span class=\"built_in\">console</span>.log(b1)<span class=\"comment\">//&#123; name: 'javaScript' &#125;</span></span><br><span class=\"line\"><span class=\"built_in\">console</span>.log(b2)<span class=\"comment\">//&#123; name: 'javaScript' &#125;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">objectFactory</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">var</span> obj = <span class=\"keyword\">new</span> <span class=\"built_in\">Object</span>(),</span><br><span class=\"line\">    Constructor = [].shift.call(<span class=\"built_in\">arguments</span>);</span><br><span class=\"line\">    obj.__proto__ = Constructor.prototype;</span><br><span class=\"line\">    <span class=\"keyword\">var</span> ret = Constructor.apply(obj, <span class=\"built_in\">arguments</span>);</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"keyword\">typeof</span> ret === <span class=\"string\">'object'</span> ? ret : obj;</span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure></li>\n</ul>","prev":{"title":"JavaScript设计模式之观察者模式","link":"2020/07/25/JavaScript设计模式之观察者模式"},"next":{"title":"leeocde-148-链表排序","link":"2020/06/09/leeocde-链表排序"},"plink":"https://edsion11.github.io/2020/06/27/手动实现的call-apply-bind-new/","toc":[{"id":"call","title":"call","index":"1"},{"id":"apply","title":"apply","index":"2"},{"id":"bind","title":"Bind","index":"3"},{"id":"new","title":"new","index":"4"}],"copyright":{"author":"Edsion Gu","link":"<a href=\"https://edsion11.github.io/2020/06/27/手动实现的call-apply-bind-new/\" title=\"手动实现的call,apply,bind,new\">https://edsion11.github.io/2020/06/27/手动实现的call-apply-bind-new/</a>","license":"Attribution-NonCommercial-NoDerivatives 4.0 International (<a href=\"https://creativecommons.org/licenses/by-nc-sa/4.0/\" rel=\"external nofollow noopener\" target=\"_blank\">CC BY-NC-ND 4.0</a>)"}}